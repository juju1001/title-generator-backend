// server/server.js
const express = require('express')
const cors = require('cors')
const axios = require('axios')
require('dotenv').config()

const app = express()
const PORT = process.env.PORT || 3001

app.use(
  cors({
    origin: ['http://localhost:5173', 'https://yourdomain.com'],
    credentials: true,
  }),
)

app.use(express.json())

// âœ… å®šä¹‰é£æ ¼æ¨¡æ¿ï¼ˆç›´æ¥å†™åœ¨ server.js é‡Œï¼‰
const STYLE_PROMPTS = {
  çˆ†æ¬¾å°çº¢ä¹¦: `
ä½ æ˜¯ä¸€ä¸ªå°çº¢ä¹¦çˆ†æ¬¾æ ‡é¢˜ç”Ÿæˆå™¨ï¼Œè¯·æ ¹æ®ä¸»é¢˜â€œ{ä¸»é¢˜}â€ï¼Œç”Ÿæˆ5ä¸ªå¸å¼•çœ¼çƒã€å¸¦emojiã€å£è¯­åŒ–ã€æœ‰æ‚¬å¿µæˆ–æƒ…ç»ªå…±é¸£çš„æ ‡é¢˜ã€‚

è¦æ±‚ï¼š
- æ¯ä¸ªæ ‡é¢˜ä¸è¶…è¿‡20å­—
- å¿…é¡»å¸¦1-2ä¸ªemoji
- ç”¨â€œæˆ‘â€ã€â€œä½ â€ã€â€œè°æ‡‚å•Šâ€ã€â€œæ•‘å‘½â€ã€â€œçœŸçš„ç»äº†â€ç­‰å£è¯­è¯
- é£æ ¼ï¼šæ´»æ³¼ã€ç§è‰ã€æƒ…ç»ªå…±é¸£

ç¤ºä¾‹ï¼š
ğŸ”¥è°æ‡‚å•Šï¼å¥èº«3ä¸ªæœˆï¼Œè…°å›´ç‹‚å‡8cmï¼
ğŸ’¥æ‰“å·¥äººå¿…çœ‹ï¼5åˆ†é’Ÿæå®šå‘¨æŠ¥ï¼Œè€æ¿ç‹‚å¤¸ï¼
âœ¨ç´ äººæ”¹é€ ï½œæ¢å‘å‹=æ¢å¤´ï¼é—ºèœœè¿½ç€é—®é“¾æ¥ï¼

è¯·ç›´æ¥è¾“å‡ºæ ‡é¢˜ï¼Œä¸è¦è§£é‡Šï¼Œä¸è¦åºå·ï¼Œæ¯è¡Œä¸€ä¸ªã€‚
âš ï¸ æ³¨æ„ï¼šä¸è¦è§£é‡Šè¯è¯­å«ä¹‰ï¼ä¸è¦å†™â€œç¤ºä¾‹â€ï¼ç›´æ¥ç”Ÿæˆæ ‡é¢˜ï¼
`,

  çŸ¥ä¹ä¸“ä¸šé£: `
ä½ æ˜¯ä¸€ä¸ªçŸ¥ä¹é«˜èµæ ‡é¢˜ç”Ÿæˆå™¨ï¼Œè¯·æ ¹æ®ä¸»é¢˜â€œ{ä¸»é¢˜}â€ï¼Œç”Ÿæˆ5ä¸ªç†æ€§ã€æœ‰æ·±åº¦ã€å¸¦æ–¹æ³•è®ºæˆ–æ•°æ®æ”¯æ’‘çš„æ ‡é¢˜ã€‚

è¦æ±‚ï¼š
- æ¯ä¸ªæ ‡é¢˜ä¸è¶…è¿‡25å­—
- ç”¨â€œä¸ºä»€ä¹ˆâ€ã€â€œå¦‚ä½•â€ã€â€œæœ‰å“ªäº›â€ã€â€œæ·±åº¦è§£æâ€ç­‰è¯
- é£æ ¼ï¼šä¸“ä¸šã€å†·é™ã€æœ‰ä¿¡æ¯å¢é‡

ç¤ºä¾‹ï¼š
ä¸ºä»€ä¹ˆ90%çš„äººå¥èº«3ä¸ªæœˆå°±æ”¾å¼ƒï¼Ÿç§‘å­¦è§£æ+è§£å†³æ–¹æ¡ˆ
å¦‚ä½•ç”¨ã€Œç•ªèŒ„å·¥ä½œæ³•ã€æå‡300%æ•ˆç‡ï¼Ÿäº²æµ‹æœ‰æ•ˆ
æœ‰å“ªäº›ä¸ä¸ºäººçŸ¥çš„ç§Ÿæˆ¿é¿å‘æŒ‡å—ï¼Ÿå¾‹å¸ˆæœ‹å‹å‘Šè¯‰æˆ‘è¿™äº›

è¯·ç›´æ¥è¾“å‡ºæ ‡é¢˜ï¼Œä¸è¦è§£é‡Šï¼Œä¸è¦åºå·ï¼Œæ¯è¡Œä¸€ä¸ªã€‚
âš ï¸ æ³¨æ„ï¼šä¸è¦è§£é‡Šè¯è¯­å«ä¹‰ï¼ä¸è¦å†™â€œç¤ºä¾‹â€ï¼ç›´æ¥ç”Ÿæˆæ ‡é¢˜ï¼
`,

  æŠ–éŸ³çŸ­å¹³å¿«: `
ä½ æ˜¯ä¸€ä¸ªæŠ–éŸ³çˆ†æ¬¾æ ‡é¢˜ç”Ÿæˆå™¨ï¼Œè¯·æ ¹æ®ä¸»é¢˜â€œ{ä¸»é¢˜}â€ï¼Œç”Ÿæˆ5ä¸ªå‰3ç§’å°±èƒ½æŠ“ä½çœ¼çƒçš„æ ‡é¢˜ã€‚

è¦æ±‚ï¼š
- æ¯ä¸ªæ ‡é¢˜ä¸è¶…è¿‡15å­—
- å¼€å¤´å¿…é¡»æœ‰å¼ºé’©å­ï¼šâ€œæ³¨æ„ï¼â€ã€â€œé€Ÿçœ‹ï¼â€ã€â€œåˆ«åˆ’èµ°ï¼â€ã€â€œæœ€å1ç§’æƒŠå‘†ï¼â€
- ç”¨æ„Ÿå¹å·ã€é—®å·ã€çœç•¥å·åˆ¶é€ æ‚¬å¿µ
- é£æ ¼ï¼šå¿«èŠ‚å¥ã€å¼ºå†²å‡»ã€åè½¬ç»“å±€

ç¤ºä¾‹ï¼š
æ³¨æ„ï¼è¿™æ ·ç¡è§‰=æ…¢æ€§è‡ªæ€ï¼
é€Ÿçœ‹ï¼æœˆè–ª3åƒåˆ°3ä¸‡ï¼Œæˆ‘åªåšäº†è¿™ä»¶äº‹...
åˆ«åˆ’èµ°ï¼99%äººä¸çŸ¥é“çš„å¾®ä¿¡éšè—åŠŸèƒ½ï¼

è¯·ç›´æ¥è¾“å‡ºæ ‡é¢˜ï¼Œä¸è¦è§£é‡Šï¼Œä¸è¦åºå·ï¼Œæ¯è¡Œä¸€ä¸ªã€‚
âš ï¸ æ³¨æ„ï¼šä¸è¦è§£é‡Šè¯è¯­å«ä¹‰ï¼ä¸è¦å†™â€œç¤ºä¾‹â€ï¼ç›´æ¥ç”Ÿæˆæ ‡é¢˜ï¼
`,

  æ¯’èˆŒåæ§½é£: `
ä½ æ˜¯ä¸€ä¸ªæ¯’èˆŒæ®µå­æ‰‹ï¼Œè¯·æ ¹æ®ä¸»é¢˜â€œ{ä¸»é¢˜}â€ï¼Œç”Ÿæˆ5ä¸ªå¸¦åè½¬ã€æƒ…ç»ªã€åæ§½çš„æ ‡é¢˜ã€‚

è¦æ±‚ï¼š
- æ¯ä¸ªæ ‡é¢˜ä¸è¶…è¿‡20å­—
- ç”¨â€œç¬‘æ­»â€ã€â€œè°æ‡‚â€ã€â€œç¦»è°±â€ã€â€œæ±‚ä½ ä»¬åˆ«...â€ã€â€œæˆ‘åˆ...â€ç­‰æƒ…ç»ªè¯
- å¸¦åè½¬ or è‡ªå˜² or å¤¸å¼ 
- é£æ ¼ï¼šçŠ€åˆ©ã€å¹½é»˜ã€æœ‰ç½‘æ„Ÿ

ç¤ºä¾‹ï¼š
ç¬‘æ­»ï¼è°å®¶å¥½äººä¸Šç­å¸¦é¥­å•Šï¼Ÿ
è°æ‡‚å•Šï¼ç”·æœ‹å‹è¯´â€œå¤šå–çƒ­æ°´â€é‚£ä¸€åˆ»æˆ‘è£‚å¼€äº†
æ±‚ä½ ä»¬åˆ«å†ä¹°ç½‘çº¢å°å®¶ç”µäº†ï¼æ™ºå•†ç¨ç¬¬ä¸€åï¼

è¯·ç›´æ¥è¾“å‡ºæ ‡é¢˜ï¼Œä¸è¦è§£é‡Šï¼Œä¸è¦åºå·ï¼Œæ¯è¡Œä¸€ä¸ªã€‚
âš ï¸ æ³¨æ„ï¼šä¸è¦è§£é‡Šè¯è¯­å«ä¹‰ï¼ä¸è¦å†™â€œç¤ºä¾‹â€ï¼ç›´æ¥ç”Ÿæˆæ ‡é¢˜ï¼
`,
}

// âœ… æ„å»º Prompt çš„å‡½æ•°
function buildPrompt(promptText, style = 'çˆ†æ¬¾å°çº¢ä¹¦') {
  const template = STYLE_PROMPTS[style] || STYLE_PROMPTS['çˆ†æ¬¾å°çº¢ä¹¦']
  return template.replace('{ä¸»é¢˜}', promptText.trim())
}

// âœ… ä»£ç†æ¥å£ï¼šæ¥æ”¶å‰ç«¯è¯·æ±‚ â†’ ç”Ÿæˆ Prompt â†’ è½¬å‘ç»™ DashScope
app.post('/api/generate', async (req, res) => {
  try {
    // âœ… è·å– prompt å’Œ style
    const { prompt, style } = req.body

    if (!prompt) {
      return res.status(400).json({ error: 'Prompt ä¸èƒ½ä¸ºç©º' })
    }

    const apiKey = process.env.QWEN_API_KEY
    if (!apiKey) {
      return res.status(500).json({ error: 'æœåŠ¡å™¨æœªé…ç½®APIå¯†é’¥' })
    }

    // âœ… æ„å»ºåŠ¨æ€ Promptï¼
    const finalPrompt = buildPrompt(prompt, style)

    console.log('ğŸ¨ é€‰æ‹©é£æ ¼:', style)
    console.log('ğŸ“ æœ€ç»ˆPrompt:', finalPrompt)

    const response = await axios.post(
      'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
      {
        model: 'qwen-turbo',
        input: {
          prompt: finalPrompt, // ğŸ‘ˆ å…³é”®ï¼ç”¨æ„å»ºå¥½çš„ Promptï¼
        },
        parameters: {
          result_format: 'text',
        },
      },
      {
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${apiKey}`,
        },
        timeout: 30000,
      },
    )

    if (response.data?.output?.text) {
      // âœ… è¿‡æ»¤æ‰ç¤ºä¾‹ã€è¦æ±‚ã€ç©ºè¡Œ
      const titles = response.data.output.text
        .split('\n')
        .map((t) => t.trim())
        .filter((t) => {
          return (
            t.length > 0 &&
            !t.startsWith('//') &&
            !t.includes('ç¤ºä¾‹ï¼š') &&
            !t.includes('è¦æ±‚ï¼š') &&
            !t.includes('æ³¨æ„ï¼š') &&
            !t.includes('é£æ ¼ï¼š') &&
            !t.includes('ä½ æ˜¯ä¸€ä¸ª')
          )
        })
        .slice(0, 10)

      res.json({ titles })
    } else {
      res.status(500).json({
        error: 'AIè¿”å›æ ¼å¼å¼‚å¸¸',
        raw: response.data,
      })
    }
  } catch (error) {
    console.error('AIç”Ÿæˆå¤±è´¥:', error.message)
    res.status(500).json({
      error: 'AIæœåŠ¡è°ƒç”¨å¤±è´¥',
      details: process.env.NODE_ENV === 'development' ? error.message : undefined,
    })
  }
})

// å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
  res.json({ status: 'OK', message: 'åç«¯ä»£ç†è¿è¡Œä¸­' })
})
app.listen(PORT, "0.0.0.0", () => {
  console.log(`ğŸš€ åç«¯ä»£ç†è¿è¡Œåœ¨ http://0.0.0.0:${PORT}`);
  console.log(`âœ… å¥åº·æ£€æŸ¥: /health`);
  console.log(`âœ… ç”Ÿæˆæ¥å£: POST /api/generate`);
});
